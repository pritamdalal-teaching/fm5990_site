<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />


<meta name="author" content="Pritam Dalal" />


<title>Tutorial 07 - Functions and Interation</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/flatly.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />

</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 60px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 65px;
  margin-top: -65px;
}

.section h2 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h3 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h4 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h5 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h6 {
  padding-top: 65px;
  margin-top: -65px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->






<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">FM 5990</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="instructor.html">Instructor</a>
</li>
<li>
  <a href="weekly_plan.html">Weekly Plan</a>
</li>
<li>
  <a href="project.html">Project</a>
</li>
<li>
  <a href="tutorials_and_exercises.html">Tutorials &amp; Exercises</a>
</li>
<li>
  <a href="slides.html">Slides</a>
</li>
<li>
  <a href="self_study.html">Self-Study</a>
</li>
<li>
  <a href="data.html">Data</a>
</li>
<li>
  <a href="syllabus.html">Syllabus</a>
</li>
<li>
  <a href="partners.html">Partners</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Tutorial 07 - Functions and Interation</h1>
<h4 class="author"><em>Pritam Dalal</em></h4>

</div>


<blockquote>
<p>“Stop using Microsoft Word. It’s lame.”</p>
<p>— Anonymous</p>
</blockquote>
<!-- The quote above isn't real, but is should be.  I put it there so you can see and example of a block quote text.  Oh, and this is what a comment looks like in R Markdown, you can comment out anything using the hot key ctrl+shift+c -->
<p>The purpose of this tutorial is to explore the <em>Option History Practice</em> data set within the context of an R Markdown (<code>.Rmd</code>) file. Along the way we will discuss iteration, flow-control, and functions in R.</p>
<p>My intention is for you to interact with this document in the source window, and not necessarily for you to knit. However, you can try knitting in order to explore the html output format. It will be good practice for you to try to make things look pretty.</p>
<p>  <!-- What does this bit of code do? --></p>
<div id="loading-libraries" class="section level4">
<h4>Loading Libraries</h4>
<p>Let’s start by first loading the libraries we will use for our analysis. This is done in a <em>code chunk</em>. You can type in code and run it either one line at a time, or the entire chunk.</p>
<p><strong>NOTE:</strong> You don’t have to <code>knit</code> an R Markdown file in order to run the code. In fact, doing so will slow you down. Instead, just highlight and then press <code>ctrl\cmd + ENTER</code> like you do in a <code>.R</code> script file. You can also press <code>ctrl\cmd + shift + ENTER</code>.</p>
<pre class="r"><code>##&gt;library(readr)
##&gt;library(dplyr)</code></pre>
<p> </p>
</div>
<div id="reading-in-data-and-viewing-it" class="section level4">
<h4>Reading-In Data and Viewing It</h4>
<p>Now that we have <code>readr</code> loaded, let’s read in our two options data sets. In each of the uses of <code>readr::read_csv()</code> I added a second argument of <code>col_types=cols()</code>. The only reason I did this was to supress annoying warning messages about.</p>
<pre class="r"><code>##&gt;df_market_history &lt;- read_csv(&quot;data_practice_market_history.csv&quot;, col_types=cols())
##&gt;df_option_history &lt;- read_csv(&quot;data_practice_option_history.csv&quot;, col_types=cols())</code></pre>
<p>Let’s get a sense for the data by using the <code>View()</code> function directly in the console. However, if you try to <code>knit</code> the document with <code>View()</code> in a code chunk, you will get an error. Why does this make sense?</p>
<pre class="r"><code>##&gt; View(df_market_history)
##&gt; View(df_option_history)</code></pre>
<p>Some observations about the data:</p>
<ol style="list-style-type: decimal">
<li><p>Notice that <code>df_market_history</code> contains fields call <code>atm_volatility</code>, <code>swap_rate</code>, and <code>implied_forward</code>. These are market-related measurements. They <em>give you a sense for where the market is</em>.</p></li>
<li><p>On the other hand, <code>df_option_history</code> simply has historical prices for options. There is no <em>summarizing</em> market data.</p></li>
<li><p>When we backtest options strategies, we will use <code>df_market_history</code> to determine which options to trade on a given day, if any.</p></li>
<li><p>We will use <code>df_option_history</code> to track the PNL of options that we trade in our strategy.</p></li>
</ol>
<p> </p>
</div>
<div id="calculating-the-pnl-on-an-options-trade-iteration-flow-control" class="section level4">
<h4>Calculating the PNL on an Options Trade (iteration + flow-control)</h4>
<p>Suppose on Friday 8/13/2013, our strategy has us sell a 30-delta SPY put that expires on 9/21/2013. Suppose our strategy involved holding this position until it expiration. In this section we calculate the daily cummulative PNL on the trade.</p>
<p>First, we query <code>df_market_history</code> to find the option that we want to trade.</p>
<pre class="r"><code>##&gt; spy_put &lt;-
##&gt;   df_market_history %&gt;% 
##&gt;   filter(underlying == &quot;SPY&quot;) %&gt;% 
##&gt;   filter(expiration == as.Date(&quot;2013-09-21&quot;)) %&gt;% 
##&gt;   filter(trade_date == as.Date(&quot;2013-08-16&quot;)) %&gt;% 
##&gt;   # ^^ OTM SPY chain expiring on 9/21 as of 8/16 ^^
##&gt;   filter(type == &quot;put&quot;) %&gt;% 
##&gt;   filter(delta &lt; 0.31) %&gt;%
##&gt;   # filtering for puts with a delta of less than 31
##&gt;   top_n(1, delta)
##&gt;   # grabbing the one with largest delta, i.e. nearest-the-money </code></pre>
<p>Let’s use the cash-money notation to see what the strike and delta of <code>spy_put</code> is.</p>
<pre class="r"><code>##&gt; spy_put$strike[1]
##&gt; spy_put$delta[1]</code></pre>
<p>We’ve isolated the option with wanted to trade on 8/16, which is the 9/21 161 SPY put. Now we can use <code>df_option_history</code> to get the daily prices for the option from 8/16 to expiration.</p>
<pre class="r"><code>##&gt; spy_put_history &lt;- 
##&gt;   df_option_history %&gt;% 
##&gt;   filter(underlying == &quot;SPY&quot;) %&gt;% 
##&gt;   filter(expiration == as.Date(&quot;2013-09-21&quot;)) %&gt;% 
##&gt;   filter(type == &quot;put&quot;) %&gt;% 
##&gt;   filter(strike == 161) %&gt;% 
##&gt;   arrange(trade_date)

##&gt; print(spy_put_history)</code></pre>
<p>As a simple sanity check let’s make sure the bid/ask prices in <code>spy_put</code> which that we queried from <code>df_market_history</code> are the same as the bid/ask prices for 8/16 in <code>spy_put_hist</code> which we queried from <code>df_market_history</code>.</p>
<pre class="r"><code>##&gt; spy_put$bid[1]
##&gt; spy_put_history$bid[1]
##&gt; spy_put$ask[1]
##&gt; spy_put_history$ask[1]</code></pre>
<p>Let’s use <code>View()</code> to take a look at the price history of the option.</p>
<pre class="r"><code>##&gt; View(spy_put_history)</code></pre>
<p>Next, we will create a little data frame that we are going to use to calculate our PNL.</p>
<pre class="r"><code>##&gt; df_pnl &lt;- spy_put_history %&gt;% 
##&gt;   select(trade_date, bid, ask) %&gt;% 
##&gt;   mutate(daily_pnl = 0, cumm_pnl = 0)

##&gt; View(df_pnl)</code></pre>
<p>Now, we are going to write a for-loop to calculate the daily pnl of this option, meaning we are going to fill in <code>df_pnl</code>. For-loops are a simple method of <em>iterating</em>: repeating a similar set of actions multiple times. With a for-loop, you know how many times you’ll need to repeat the action.</p>
<p>We are going to use a for-loop to fill in <code>df_pnl</code>, which we can conceptualize as iterating over a data-frame and performing the “fill-in” action repeated until we get through all the rows.</p>
<pre class="r"><code>##&gt; for (ix_trade_date in 1:nrow(df_pnl)) {
##&gt;   #fill in df_pnl$daily_pnl
##&gt;   if (ix_trade_date == 1) {
##&gt;     df_pnl$daily_pnl[ix_trade_date] &lt;- 0
##&gt;   }
##&gt;   else if (ix_trade_date == 2) {
##&gt;     df_pnl$daily_pnl[ix_trade_date] = df_pnl$bid[ix_trade_date - 1] - df_pnl$ask[ix_trade_date]  
##&gt;   }
##&gt;   else {
##&gt;     df_pnl$daily_pnl[ix_trade_date] = df_pnl$ask[ix_trade_date - 1] - df_pnl$ask[ix_trade_date]
##&gt;   }
##&gt;   
##&gt;   #fill in df_pnl$cumm_pnl
##&gt;   df_pnl$cumm_pnl[ix_trade_date] = sum(df_pnl$daily_pnl[1:ix_trade_date])
##&gt; }
##&gt; print(df_pnl)</code></pre>
<p>Note that this option expired out of the money, which means that the total cummulative PNL should be equal to whatever we sold the option for initially. We can confirm this by summing <code>df_pnl$daily_pnl</code>. And also by checking the <code>cumm_pnl</code> column.</p>
<pre class="r"><code>##&gt; sum(df_pnl$daily_pnl)</code></pre>
<p><strong>EXERCISE:</strong></p>
<ol style="list-style-type: decimal">
<li>Repeat this PNL calculation for the 161 call. Start by creating <code>spy_call</code> and <code>spy_call_history</code> and then create a PNL dataframe called <code>df_call_pnl</code> that you will fill in with a for-loop.</li>
</ol>
<p> </p>
</div>
<div id="creating-an-payoff-function-functions-flow-control" class="section level4">
<h4>Creating An Payoff Function (functions + flow-control)</h4>
<p>We won’t do a ton of function writing in this class, but it’s such a central concept in R (and programming in general) that I would be remiss to not metion it.</p>
<p>There are a couple of situation where you may want to write a function:</p>
<ol style="list-style-type: decimal">
<li><p>When you find yourself writing the same chunk of code over and over again with small variations.</p></li>
<li><p>You’ve written a big long sequence of code that you want to break up so it’s more manigable, and it’s easier to track bugs.</p></li>
</ol>
<p>NOTE: some other programming languages make a distinction between functions, procedures, methods, etc. R does not - there are only scripts and functions.</p>
<p>Functions can return values, or not return values.</p>
<p>Let’s take a look at the September 2013 SPY options in <code>df_option_history</code> on their final trading day. We will focus our attention to options that expire in the money. Notice from this query that the <code>bid</code> and <code>ask</code> of the the option is set to payoff of the option.</p>
<pre class="r"><code>##&gt; df_expiring_options &lt;-
##&gt;   df_option_history %&gt;% 
##&gt;     filter(underlying == &quot;SPY&quot;) %&gt;% 
##&gt;     filter(expiration == as.Date(&quot;2013-09-21&quot;)) %&gt;% 
##&gt;     filter(trade_date == as.Date(&quot;2013-09-20&quot;)) %&gt;% 
##&gt;     filter(bid &gt; 0) %&gt;% 
##&gt;     arrange(strike)
 
##&gt; View(df_expiring_options)</code></pre>
<p>What we are going to do is write a simple function that calculates the payoff of an option give the <code>type</code>, <code>strike</code>, and settle <code>upx</code> of the underlying. Notice that once you run the <code>option_payoff</code> definition code that the function now lives in the environment.</p>
<pre class="r"><code>##&gt; option_payoff &lt;- function(type, strike, upx){
##&gt;   if (type == &quot;call&quot;){
##&gt;     max(upx - strike, 0)    
##&gt;   } else if (type == &quot;put&quot;) {
##&gt;     max(strike - upx, 0)
##&gt;   } else {
##&gt;     stop(&quot;unknown option type&quot;)
##&gt;   }
##&gt; }

##&gt; corp &lt;- &quot;call&quot;
##&gt; K &lt;- 100
##&gt; S &lt;- 100
##&gt; option_payoff(corp, K, S)</code></pre>
<p><strong>Exercises:</strong></p>
<ol style="list-style-type: decimal">
<li><p>Use <code>dplyr::select()</code> to create a sub-dataframe from <code>df_expiring_options</code> that contains the columns <code>type</code>, <code>strike</code>, <code>upx</code>, and <code>bid</code>. Call this sub-dataframe <code>df_payoffs</code>.</p></li>
<li><p>Use <code>dplyr::mutate()</code> to add a column to <code>df_payoffs</code> called <code>payoff</code> and initialize it’s values with 0.</p></li>
<li><p>Write a for-loop to interate through <code>df_payoff</code> and fill in the <code>payoff</code> column with our function <code>option_payoff</code>.</p></li>
</ol>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
