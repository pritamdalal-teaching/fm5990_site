---
title: "Tutorial 08 - Data Visualization 1"
author: "Pritam Dalal"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The purpose of this tutorial is to introduce you to data visualization with the `ggplot2` package.  Visualization is a massive subject and we are only going to scratch the surface.  My approach will be to introduce this area by way of creating graphs that help us understand the *Option History Practice* data set.  This is merely an introduction, and is by no mean comprehensive.

#### Loading Libraries and Reading Data
Load the libraries...like a boss.
```{r}
# library(tidyverse)
```

Read in the data...like a boss.
```{r}
# df_market_history <- read_csv("data_practice_market_history.csv", col_types = cols())
```

Look at the data, because it's pretty.
```{r}
# df_market_history
```



#### Liquidity - Volume vs Spread

*Liquidity* is an extremely important concept in trading.  We say that a security or instrument is *liquid* if three things hold.

1. Large volumes trade daily.

2. There is a narrow bid-ask spread.

3. Large quantities can be traded with out moving the bid or ask.

Usually it is the case that these three things go together.  The purpose of this analysis will be to demonstrate that #1 and #2 coincide in our options data
```{r}
# # create a liquidity report with dplyr
# df_liquidity <-
#   df_market_history %>% 
#     group_by(underlying) %>% 
#     summarize(daily_volume = (sum(volume) / nrow(df_market_history %>% distinct(trade_date)))
#               ,avg_spread = mean(ask - bid)) %>% 
#     arrange(desc(daily_volume))
# df_liquidity
# 
# # base graph (this is worthless because the huge volume outliers - can you guess what they are?)
# qplot(daily_volume, avg_spread, data = df_liquidity, geom="point")
# 
# # it's often useful to take the logs in this situation - now it's easier to see that high volumes correlate with narrow sreads
# qplot(log(daily_volume), avg_spread, data = df_liquidity, geom="point")
# 
# # let's add a smooth line because it's baller
# qplot(log(daily_volume), avg_spread, data = df_liquidity, geom=c("point","smooth"))
# 
# # another approach is to make this unit-less by plotting the rank of the volume
# qplot(log(daily_volume), avg_spread, data = df_liquidity, geom=c("point","smooth"))
# 
# # let's reproduce this graph using ggplot()
# ggplot(data = df_liquidity) +
#   geom_point(mapping = aes(x = log(daily_volume), y = avg_spread)) +
#   geom_smooth(mapping = aes(x = log(daily_volume), y = avg_spread), se = FALSE, method = "loess")
```

**Exercises:**

1. Google to figure out how you can make `geom_smooth()` graph a regression line instead of it's default behavior.



#### Deltas of OTM Options
ATM options have a 50 (absolute) delta.  The farther out of the money an option is, the smaller it's delta becomes.  We are going to demostrate this with our data.

Let's graph the absolute deltas of OTM options and see the relationship between strike and delta.  To keep things simple we will focus on SPY for 8/16/2013.
```{r}
# # let's look at SPY chain from a particular day: 8/16/2013 
# df_spy <-
#   df_market_history %>% 
#     filter(underlying == "SPY") %>% 
#     filter(trade_date == as.Date("2013-08-16"))
# df_spy
# 
# # basic plot - scatter plot with geom_point()
# ggplot(data = df_spy) +
#   geom_point(mapping = aes(x = strike, y = delta))
# 
# # let's make this unit-less by setting the x-coordinate to log(strike/implied_forward) - this is sometimes referred to as the "log-strike" or "log-moniness".
# ggplot(data = df_spy) +
#   geom_point(mapping = aes(x = log(strike/implied_forward), y = delta))
```




#### OTM Option Prices
Let's look at OTM option prices for a variety of underlyings on a particular day.

```{r}
# # introducing the purr::map_dbl() function
# # it allows you to easily vectorize a user defined function
# # see Jenny Bryan's purrr tutorial for more on this
# f <- function(corp){
#   if (corp == "put") {-1} else {1}
# }
# 
# f("put")
# f(df_market_history$type) # can't put in a vector like built in functions
# purrr::map_dbl(df_market_history$type, f) # this worked
# 
# 
# df_index_options <- 
#   df_market_history %>% 
#     # filter just the big four ETFs
#     filter(underlying %in% c("SPY", "IWM", "QQQ", "DIA")) %>% 
#     filter(trade_date == as.Date("2013-08-16")) %>% 
#     # adding the signed delta column using a bit of functional programming
#     mutate(signed_delta = delta * map_dbl(type, function(corp) {if(corp == "put"){-1} else {1}}))
# 
# 
# #look at the data frame
# df_index_options
# 
# # basic plot
# ggplot(data = df_index_options) +
#   geom_point(mapping = aes(x = strike, y = bid))
# # add colors for underlying
# ggplot(data = df_index_options) +
#   geom_point(mapping = aes(x = strike, y = bid, color = underlying))
# # use log(strike) and relative option price to remove units, this allows for easier comparison
# ggplot(data = df_index_options) +
#   geom_point(mapping = aes(x = log(strike/implied_forward), y = bid/implied_forward, color = underlying))
# # add the facet to see all of these side-by-side - but they look all squished together.  
# ggplot(data = df_index_options) +
#   geom_point(mapping = aes(x = log(strike/implied_forward), y = bid/implied_forward, color = underlying)) +
#   facet_wrap(~ underlying, nrow = 1)
# # have two rows on the facet so that it looks better.
# ggplot(data = df_index_options) +
#   geom_point(mapping = aes(x = log(strike/implied_forward), y = bid/implied_forward, color = underlying)) +
#   facet_wrap(~ underlying, nrow = 2)
```


**5-minute Challenge:** Based on the final graph above, which underlying do you think has the highest ATM volatility on 8/16/2013?  Veryify your hypothesis with a query on df_market_history.

```{r}
## Solution:
```




#### Implied Volatility Skews
It's often useful to look at volatility skews.  We'll use the `df_index_options` dataframe that we created above.

```{r}
# # basic scatter plot
# ggplot(data = df_index_options) +
#   geom_point(mapping = aes(x = strike, y = implied_vol))
# 
# # let's add a little flair 
# ggplot(data = df_index_options) +
#   geom_point(mapping = aes(x = strike, y = implied_vol, color = underlying))
# 
# # facet wrap - looks crappy because we didn't normalzie strike 
# ggplot(data = df_index_options) +
#   geom_point(mapping = aes(x = strike, y = implied_vol, color = underlying)) +
#   facet_wrap(~ underlying, nrow = 2)
# 
# # normalizing strike 
# ggplot(data = df_index_options) +
#   geom_point(mapping = aes(x = log(strike/implied_forward), y = implied_vol, color = underlying)) +
#   facet_wrap(~ underlying, nrow = 2)
```


#### Skews Through Time
We can visualize skews through time.
```{r}
# # grabbing all SPY skews for the 9/21/2013 expiration
# df_spy_time <-
#   df_market_history %>% 
#     filter(underlying == "SPY") %>%
#     filter(expiration == as.Date("2013-09-21")) %>% 
#     arrange(trade_date, strike)
#   
# # basic plot
# ggplot(data = df_spy_time) +
#   geom_point(mapping = aes(x = strike, y = implied_vol))
# 
# # let's look at less data and apply color differentiation to trade_date
# ggplot(data = df_spy_time %>% filter(trade_date < as.Date("2013-09-01"))) +
#   geom_point(mapping = aes(x = strike, y = implied_vol, color = trade_date))
# 
# # lets use a line instead
# ggplot(data = df_spy_time %>% filter(trade_date < as.Date("2013-09-01"))) +
#   geom_line(mapping = aes(x = strike, y = implied_vol, group = trade_date, color = trade_date))
# 
# 
# # log-strike, like a boss
# ggplot(data = df_spy_time %>% filter(trade_date < as.Date("2013-09-01"))) +
#   geom_line(mapping = aes(x = log(strike/implied_forward), y = implied_vol, group = trade_date, color = trade_date))

```

